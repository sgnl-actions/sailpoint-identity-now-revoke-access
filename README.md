# SailPoint IdentityNow Revoke Access Action

This action creates an access request in SailPoint IdentityNow to revoke access to roles, access profiles, or entitlements for a specified identity.

## Quick Start

1. **Clone** this repository locally
2. **Install dependencies**: `npm install`
3. **Configure** your SailPoint IdentityNow credentials
4. **Test locally**: `npm run dev`
5. **Run tests**: `npm test`
6. **Build**: `npm run build`
7. **Release**: Create a git tag and push

## Configuration

### Authentication

This action supports four authentication methods. Configure one of the following:

#### Option 1: Bearer Token (SailPoint API Token)
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `BEARER_AUTH_TOKEN` | Secret | Yes | Bearer token for SailPoint IdentityNow API authentication |

#### Option 2: Basic Authentication
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `BASIC_USERNAME` | Secret | Yes | Username for SailPoint IdentityNow authentication |
| `BASIC_PASSWORD` | Secret | Yes | Password for SailPoint IdentityNow authentication |

#### Option 3: OAuth2 Client Credentials
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET` | Secret | Yes | OAuth2 client secret |
| `OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID` | Environment | Yes | OAuth2 client ID |
| `OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL` | Environment | Yes | OAuth2 token endpoint URL |
| `OAUTH2_CLIENT_CREDENTIALS_SCOPE` | Environment | No | OAuth2 scope |
| `OAUTH2_CLIENT_CREDENTIALS_AUDIENCE` | Environment | No | OAuth2 audience |
| `OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE` | Environment | No | OAuth2 auth style |

#### Option 4: OAuth2 Authorization Code
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN` | Secret | Yes | OAuth2 access token |

### Environment Variables

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `ADDRESS` | Yes | Default SailPoint IdentityNow API base URL | `https://example.api.identitynow.com` |

## Input Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `identityId` | String | Yes | The ID of the identity requesting access revocation |
| `itemType` | String | Yes | Type of access item (ACCESS_PROFILE, ROLE, or ENTITLEMENT) |
| `itemId` | String | Yes | The ID of the access item to revoke |
| `itemComment` | String | **Yes** | Comment for the access revocation request (required for revoke) |
| `address` | String | No | SailPoint IdentityNow base URL (e.g., https://example.identitynow.com) |
| `itemRemoveDate` | DateTime | No | ISO 8601 date when access should be removed |

## Development

### Local Testing

```bash
# Run the script locally with mock data
npm run dev

# Run unit tests
npm test

# Watch mode for development
npm run test:watch
npm run build:watch

# Validate metadata
npm run validate

# Lint code
npm run lint
npm run lint:fix
```

### File Structure

- `src/script.mjs` - Main job implementation (⚠️ **Edit this!**)
- `metadata.yaml` - Job schema and configuration (⚠️ **Edit this!**)
- `tests/script.test.js` - Unit tests
- `dist/index.js` - Built script (generated by `npm run build`)
- `scripts/` - Development utilities

## Output

The action returns the following information:

| Field | Type | Description |
|-------|------|-------------|
| `requestId` | String | The ID of the access revoke request created |
| `identityId` | String | The identity ID for which access was revoked |
| `itemType` | String | The type of access item revoked |
| `itemId` | String | The ID of the access item revoked |
| `status` | String | The status of the revoke request |
| `requestedAt` | DateTime | When the revoke request was created (ISO 8601) |
| `address` | String | The SailPoint IdentityNow API base URL used |

## Event Handlers

Your script must export a default object with these handlers:

### `invoke` (Required)
Main execution logic for your job.

```javascript
invoke: async (params, context) => {
  // Your job logic here
  return {
    status: 'success',
    // ... other outputs
  };
}
```

### `error` (Optional)
Error handler that re-throws errors to let the framework handle retry logic.

```javascript
error: async (params, _context) => {
  const { error } = params;
  // Re-throw error to let framework handle retry logic
  throw error;
}
```

### `halt` (Optional)  
Graceful shutdown when job is cancelled or times out.

```javascript
halt: async (params, context) => {
  // params.reason contains halt reason
  // Clean up resources, save partial progress
  return {
    status: 'halted',
    cleanup_completed: true
  };
}
```

## Error Handling

The framework automatically handles retry logic for transient errors. The error handler simply re-throws errors, allowing the framework to determine retry behavior based on the error type and status code.

## Context Object

The `context` parameter provides access to:

```javascript
{
  env: {
    ENVIRONMENT: "production",
    // ... other environment variables
  },
  secrets: {
    API_KEY: "secret-key",
    // ... other secrets
  },
  outputs: {
    "previous-job-step": {
      // ... outputs from previous jobs in workflow
    }
  }
}
```

## Testing

### Unit Tests

Tests are in `tests/script.test.js`. Update the mock data to match your job's inputs:

```javascript
const params = {
  target: 'your-target',
  action: 'your-action'
  // ... other inputs
};
```

### Local Development

Use `npm run dev` to test your script locally with mock data. Update `scripts/dev-runner.js` to customize the test parameters.

## Deployment

1. **Ensure tests pass**: `npm test`
2. **Validate metadata**: `npm run validate`  
3. **Build distribution**: `npm run build`
4. **Create git tag**: `git tag v1.0.0`
5. **Push to GitHub**: `git push origin v1.0.0`

## Usage Example

```json
{
  "id": "revoke-access-job-123",
  "type": "nodejs-20",
  "script": {
    "repository": "github.com/sgnl-actions/sailpoint-identity-now-revoke-access",
    "version": "v1.0.0",
    "type": "nodejs"
  },
  "script_inputs": {
    "identityId": "2c91808a7d4e4e4c017d4e8a0b0a0001",
    "itemType": "ACCESS_PROFILE",
    "itemId": "2c91808a7d4e4e4c017d4e8a0b0a0002",
    "itemComment": "Access revocation required due to security policy",
    "address": "https://example.identitynow.com"
  },
  "environment": {
    "ADDRESS": "https://example.identitynow.com"
  },
  "secrets": {
    "BEARER_AUTH_TOKEN": "your-api-token"
  }
}
```


## Support

